# 排障指南

本文档汇总了 Feiyue Emby Gateway 使用过程中常见的问题和故障，并提供详细的排查步骤和解决方案。

## 1. 安装与启动问题

### 1.1 服务无法启动

**症状**：
- 执行启动命令后无响应
- 服务启动后立即退出
- 日志中显示启动失败信息

**可能原因**：
- 端口被占用
- 数据库连接失败
- 配置文件错误
- 权限不足

**解决方案**：
1. **检查端口占用**：
   ```bash
   netstat -tulpn | grep 18888
   ```
   如果端口被占用，修改配置使用其他端口。

2. **检查数据库连接**：
   - 确保数据库服务正常运行
   - 验证数据库连接字符串是否正确
   - 检查数据库用户权限

3. **检查配置文件**：
   - 验证配置文件格式是否正确
   - 检查环境变量是否设置正确

4. **检查权限**：
   - 确保可执行文件有执行权限
   - 确保数据目录有读写权限

### 1.2 Docker 容器启动失败

**症状**：
- Docker 容器状态为 `exited`
- 容器日志显示错误信息

**可能原因**：
- 环境变量配置错误
- 卷挂载问题
- 网络连接问题

**解决方案**：
1. **查看容器日志**：
   ```bash
   docker logs <container-name>
   ```

2. **检查环境变量**：
   - 确保所有必要的环境变量都已设置
   - 验证数据库连接字符串格式

3. **检查卷挂载**：
   - 确保挂载的目录存在
   - 检查目录权限

4. **检查网络连接**：
   - 确保容器间网络连通
   - 验证外部端口映射

### 1.3 启动后管理界面无法访问

**症状**：
- 浏览器无法打开管理页面
- 连接超时错误

**可能原因**：
- 管理端口配置错误
- 防火墙阻止访问
- 绑定地址错误

**解决方案**：
1. **检查管理端口**：
   - 确认启动时指定的管理端口
   - 检查容器端口映射

2. **检查防火墙**：
   - 临时关闭防火墙测试
   - 添加防火墙规则允许端口访问

3. **检查绑定地址**：
   - 确保绑定地址为 `0.0.0.0`（允许所有网络访问）
   - 或绑定到特定网络接口

## 2. 后端存储问题

### 2.1 S3 后端连接失败

**症状**：
- 测试后端连接失败
- 播放请求返回 500 错误
- 日志中显示 S3 连接错误

**可能原因**：
- Endpoint 配置错误
- Access Key 或 Secret Key 错误
- Bucket 不存在或无权限
- 网络连接问题

**解决方案**：
1. **验证 S3 配置**：
   - 检查 Endpoint URL 是否正确
   - 确认 Access Key 和 Secret Key 是否有效
   - 验证 Bucket 名称是否正确

2. **测试网络连接**：
   ```bash
   curl -v <endpoint>
   ```

3. **检查权限**：
   - 确保 S3 密钥有足够的权限
   - 检查 Bucket 策略是否允许访问

### 2.2 Google Drive 后端授权失败

**症状**：
- 测试后端连接失败
- 日志中显示授权错误
- 播放请求返回 401 或 403 错误

**可能原因**：
- Client ID 或 Client Secret 错误
- Refresh Token 过期或无效
- Google Drive API 未启用
- 权限不足

**解决方案**：
1. **重新获取授权**：
   - 按照 Google Drive 后端配置指南重新获取授权码和刷新令牌
   - 确保启用了 Google Drive API

2. **检查权限**：
   - 确保授权时授予了足够的权限（至少需要 `readonly` 权限）

3. **检查 API 配额**：
   - 确保未超出 Google Drive API 的请求配额

### 2.3 本地存储后端访问失败

**症状**：
- 测试后端连接失败
- 播放请求返回 404 或 500 错误
- 日志中显示 Local Agent 连接错误

**可能原因**：
- Local Agent 未运行
- Agent API URL 配置错误
- Sync Token 不匹配
- 本地文件权限问题

**解决方案**：
1. **检查 Local Agent 状态**：
   - 确保 Local Agent 服务正常运行
   - 检查 Agent 日志

2. **验证配置**：
   - 确认 Agent API URL 是否正确
   - 检查 Sync Token 是否与 Agent 启动时一致

3. **检查文件权限**：
   - 确保 Local Agent 有访问本地文件的权限
   - 验证文件路径是否存在

### 2.4 CDN 后端访问速度慢

**症状**：
- 播放卡顿
- 加载时间长
- 缓冲频繁

**可能原因**：
- CDN 缓存未命中
- CDN 节点问题
- 源站速度慢

**解决方案**：
1. **预热 CDN 缓存**：
   - 对于热门内容，主动预热 CDN 缓存

2. **检查 CDN 配置**：
   - 优化 CDN 缓存策略
   - 选择合适的 CDN 节点

3. **优化源站**：
   - 确保源站响应速度快
   - 考虑使用更靠近用户的源站

## 3. 路由与资源池问题

### 3.1 路由规则不匹配

**症状**：
- 请求返回 404 错误
- 使用了错误的资源池
- 播放请求失败

**可能原因**：
- 路径前缀配置错误
- 优先级设置错误
- 规则未启用

**解决方案**：
1. **检查路由规则**：
   - 验证路径前缀是否正确
   - 检查规则优先级是否合理
   - 确保规则已启用

2. **查看路由匹配日志**：
   - 在可观测性页面查看请求日志
   - 确认请求路径和匹配的规则

3. **添加默认规则**：
   - 配置一个路径前缀为 `/` 的默认规则作为兜底

### 3.2 资源池后端切换频繁

**症状**：
- 主后端频繁切换到备后端
- 播放过程中出现卡顿
- 日志中显示后端失败信息

**可能原因**：
- 主后端不稳定
- 网络连接波动
- 后端响应超时设置过短

**解决方案**：
1. **检查主后端状态**：
   - 测试主后端连接稳定性
   - 查看后端错误日志

2. **优化网络连接**：
   - 检查网络带宽和延迟
   - 考虑使用更稳定的网络连接

3. **调整超时设置**：
   - 适当增加后端响应超时时间
   - 调整健康检查间隔

### 3.3 资源池无可用后端

**症状**：
- 所有请求返回 503 错误
- 日志中显示 "no available backend"

**可能原因**：
- 所有后端都已故障
- 资源池未启用
- 后端配置错误

**解决方案**：
1. **检查后端状态**：
   - 测试所有后端连接
   - 确保至少有一个后端可用

2. **检查资源池配置**：
   - 确保资源池已启用
   - 验证资源池中是否添加了后端

3. **紧急修复**：
   - 临时添加一个可用的后端
   - 或切换到备用资源池

## 4. 播放问题

### 4.1 播放请求返回 404 错误

**症状**：
- 播放器显示 "文件未找到"
- 网关日志显示 404 错误

**可能原因**：
- 路径映射错误
- 后端存储中文件不存在
- 路由规则未匹配

**解决方案**：
1. **检查路径映射**：
   - 验证路径映射配置是否正确
   - 确保源路径和目标路径映射方向正确

2. **检查后端存储**：
   - 确认文件是否存在于后端存储中
   - 验证文件路径是否正确

3. **检查路由规则**：
   - 确保请求路径能匹配到路由规则
   - 检查资源池是否有可用后端

### 4.2 播放卡顿或缓冲频繁

**症状**：
- 播放过程中频繁缓冲
- 视频画面卡顿
- 音频不同步

**可能原因**：
- 网络带宽不足
- 后端响应速度慢
- CDN 缓存未命中
- 播放器设置问题

**解决方案**：
1. **检查网络带宽**：
   - 使用 speedtest 等工具测试网络速度
   - 确保网络带宽足够支持视频流

2. **优化后端配置**：
   - 对于频繁访问的内容，使用 CDN 加速
   - 考虑使用更靠近用户的后端存储

3. **调整播放器设置**：
   - 降低视频播放质量
   - 增加播放器缓冲大小

4. **检查 CDN 缓存**：
   - 预热 CDN 缓存
   - 优化 CDN 缓存策略

### 4.3 播放请求返回 500 错误

**症状**：
- 播放器显示 "服务器错误"
- 网关日志显示 500 错误

**可能原因**：
- 后端服务错误
- 网关内部错误
- 配置错误

**解决方案**：
1. **查看详细日志**：
   - 在可观测性页面查看请求日志
   - 检查错误详情和堆栈跟踪

2. **检查后端服务**：
   - 测试后端服务是否正常
   - 查看后端服务日志

3. **检查网关配置**：
   - 验证所有配置项是否正确
   - 检查是否有语法错误或逻辑错误

## 5. 管理界面问题

### 5.1 管理密码无法登录

**症状**：
- 输入正确密码后无法登录
- 显示 "密码错误"

**可能原因**：
- 密码输入错误
- 浏览器缓存问题
- 密码配置错误

**解决方案**：
1. **验证密码**：
   - 确认输入的密码是否正确
   - 尝试使用无痕模式登录

2. **清除浏览器缓存**：
   - 清除浏览器缓存和 cookies
   - 或使用其他浏览器登录

3. **重置密码**：
   - 如果忘记密码，可能需要重置数据库

### 5.2 管理界面加载缓慢

**症状**：
- 页面加载时间长
- 操作响应慢
- 界面卡顿

**可能原因**：
- 服务器资源不足
- 数据库性能问题
- 网络延迟

**解决方案**：
1. **检查服务器资源**：
   - 查看 CPU 和内存使用情况
   - 考虑升级服务器配置

2. **优化数据库**：
   - 对于 PostgreSQL，考虑添加索引
   - 定期清理数据库日志和临时数据

3. **检查网络连接**：
   - 测试服务器网络延迟
   - 考虑使用更稳定的网络连接

### 5.3 配置保存失败

**症状**：
- 点击保存后显示错误
- 配置更改未生效

**可能原因**：
- 数据库连接问题
- 配置参数错误
- 权限问题

**解决方案**：
1. **检查数据库连接**：
   - 确保数据库服务正常运行
   - 验证数据库连接字符串

2. **检查配置参数**：
   - 确保所有必填字段都已填写
   - 验证参数格式是否正确

3. **检查权限**：
   - 确保数据库用户有写入权限
   - 检查数据目录权限

## 6. 性能问题

### 6.1 网关响应缓慢

**症状**：
- 所有请求响应时间长
- 播放启动时间长
- 管理界面操作延迟

**可能原因**：
- 服务器资源不足
- 数据库性能问题
- 路由规则过多
- 缓存配置不当

**解决方案**：
1. **检查服务器资源**：
   - 监控 CPU、内存和磁盘使用情况
   - 考虑升级服务器配置

2. **优化数据库**：
   - 使用 PostgreSQL 替代 SQLite（生产环境）
   - 定期清理数据库

3. **优化路由规则**：
   - 减少路由规则数量
   - 优化规则优先级

4. **调整缓存配置**：
   - 增加缓存大小
   - 优化缓存过期时间

### 6.2 高并发下性能下降

**症状**：
- 并发用户增加时性能显著下降
- 出现请求超时
- 系统不稳定

**可能原因**：
- 服务器资源不足
- 连接池配置不当
- 数据库连接数限制

**解决方案**：
1. **垂直扩展**：
   - 增加服务器 CPU 和内存
   - 使用更高性能的存储

2. **水平扩展**：
   - 考虑部署多个网关实例
   - 使用负载均衡分发请求

3. **优化连接池**：
   - 增加数据库连接池大小
   - 调整 HTTP 连接超时

4. **使用 CDN**：
   - 对于静态内容，使用 CDN 减轻网关负担

## 7. 安全问题

### 7.1 管理界面未设置密码

**症状**：
- 管理界面可直接访问，无需密码
- 存在安全风险

**解决方案**：
1. **设置管理密码**：
   - 进入安全设置页面
   - 设置强密码
   - 保存配置

2. **配置 IP 访问控制**：
   - 限制只能从特定 IP 访问管理界面
   - 或使用 VPN 访问

### 7.2 安全告警触发

**症状**：
- 已配置通知渠道（企业微信/钉钉/Telegram/Bark/Server酱）收到安全告警

**可能原因**：
- 异常访问模式
- 尝试暴力破解
- 可疑 IP 访问

**解决方案**：
1. **查看告警详情**：
   - 进入「安全告警」页面检查命中规则和阈值配置
   - 结合通知内容与请求日志分析告警原因

2. **采取措施**：
   - 对于暴力破解尝试，暂时禁止相关 IP
   - 加强密码强度
   - 考虑使用 IP 访问控制

3. **调整安全规则**：
   - 根据实际情况调整安全告警规则
   - 减少误报

### 7.3 安全规则故障排查

**症状**：
- 安全规则不生效
- 误拦截正常请求
- 性能问题

**可能原因**：
- 规则的启用状态未开启
- 规则的匹配条件配置错误
- 规则的执行顺序问题
- 规则数量过多或正则表达式复杂

**解决方案**：
1. **规则不生效**：
   - 检查规则的启用状态
   - 检查规则的匹配条件是否正确
   - 检查规则的执行顺序

2. **误拦截**：
   - 检查 IP 白名单配置
   - 检查用户代理匹配规则
   - 检查路径匹配规则是否过于宽泛

3. **性能问题**：
   - 减少规则数量
   - 简化正则表达式
   - 优化规则执行顺序

### 7.4 安全告警故障排查

**症状**：
- 告警不触发
- 误报过多
- 通知未发送

**可能原因**：
- 告警规则未启用
- 通知系统未启用
- 统计窗口和阈值设置不合理
- 最小请求数设置过低

**解决方案**：
1. **告警不触发**：
   - 检查告警规则是否启用
   - 检查通知系统是否启用
   - 检查统计窗口和阈值设置是否合理
   - 检查是否达到最小请求数要求

2. **误报过多**：
   - 增加最小请求数阈值
   - 调整时间窗口长度
   - 增加冷却时间
   - 优化告警规则的匹配条件

3. **通知未发送**：
   - 检查通知渠道配置是否正确
   - 检查通知系统是否启用
   - 检查网络连接是否正常
   - 测试通知渠道是否工作正常

## 8. 其他常见问题

### 8.1 日志显示错误但功能正常

**症状**：
- 日志中显示错误信息
- 但系统功能正常，播放无问题

**可能原因**：
- 非关键错误
- 配置项缺失但有默认值
- 临时网络波动

**解决方案**：
1. **分析错误日志**：
   - 确认错误类型和严重程度
   - 检查是否影响系统功能

2. **修复可忽略的错误**：
   - 对于配置项缺失，补充配置
   - 对于临时错误，监控是否持续出现

3. **调整日志级别**：
   - 如果错误信息过多，考虑调整日志级别

### 8.2 升级后功能异常

**症状**：
- 升级到新版本后某些功能异常
- 配置丢失或不兼容

**可能原因**：
- 版本兼容性问题
- 配置格式变更
- 依赖项更新

**解决方案**：
1. **查看升级日志**：
   - 检查升级过程中是否有错误
   - 查看版本变更日志

2. **回滚或修复**：
   - 如果问题严重，考虑回滚到之前版本
   - 或根据版本说明修复配置

3. **备份配置**：
   - 升级前始终备份配置
   - 以便出现问题时快速恢复

### 8.3 许可证相关问题

**症状**：
- 系统显示许可证过期
- 某些功能被限制
- 许可证验证失败
- 激活失败

**可能原因**：
- 许可证已过期
- 许可证验证失败
- 网络连接问题
- 激活码无效或已被使用
- 许可证服务器暂时不可用

**解决方案**：
1. **检查许可证状态**：
   - 进入许可证页面查看状态
   - 确认许可证有效期

2. **重新验证许可证**：
   - 点击刷新按钮重新验证
   - 检查网络连接

3. **更新许可证**：
   - 如果许可证已过期，更新许可证
   - 确保许可证文件正确安装

4. **激活失败解决**：
   - 检查激活码是否正确
   - 确保网络连接正常
   - 稍后重试激活操作
   - 联系支持团队获取帮助

### 8.4 通知系统故障排查

**症状**：
- 通知未发送
- 通知内容错误
- 通知延迟
- 测试通知失败

**可能原因**：
- 通知系统未启用
- 通知渠道未启用
- 渠道配置错误
- 网络连接问题
- 接收端异常
- 通知模板配置错误
- 字符编码问题

**解决方案**：
1. **通知未发送**：
   - 检查通知系统是否启用
   - 检查通知渠道是否启用
   - 检查渠道配置是否正确
   - 检查网络连接是否正常
   - 检查接收端是否正常

2. **通知内容错误**：
   - 检查通知模板配置是否正确
   - 检查变量替换是否正常
   - 检查字符编码是否正确

3. **通知延迟**：
   - 检查网络延迟
   - 检查接收端处理速度
   - 检查通知发送频率限制

4. **测试通知失败**：
   - 检查渠道配置是否正确
   - 检查 API 密钥或认证信息是否正确
   - 检查网络连接是否正常
   - 检查接收端是否接受来自当前 IP 的请求

### 8.5 基本配置故障排查

**症状**：
- 配置不生效
- 播放失败
- 路由错误

**可能原因**：
- 只配了后端，忘了配资源池
- 配了资源池，路由没绑定这个资源池
- 路由优先级顺序错误，导致命中意外规则
- 路径映射写反（`from/to` 方向弄反）

**解决方案**：
1. **检查配置完整性**：
   - 确保后端、资源池、路由规则都已正确配置
   - 验证路由规则是否绑定了资源池

2. **检查路由优先级**：
   - 确保路由规则优先级设置合理
   - 具体规则应优先于通用规则

3. **检查路径映射**：
   - 验证路径映射的方向是否正确
   - 确保源路径和目标路径映射正确

4. **检查 Source 监听可达性**：
   - 新增 Source 或修改监听端口后，配置会热更新生效，无需重启
   - 若仍不可访问，优先检查 Docker 端口映射、防火墙和安全组是否放行新端口

## 9. 故障排查流程

### 9.1 基本排查步骤

1. **收集信息**：
   - 记录问题发生的时间
   - 描述问题的具体症状
   - 收集相关日志信息

2. **定位问题**：
   - 查看系统日志和请求日志
   - 确认问题发生的组件
   - 分析可能的原因

3. **尝试解决方案**：
   - 根据可能的原因尝试相应的解决方案
   - 验证解决方案是否有效

4. **记录和预防**：
   - 记录问题和解决方案
   - 采取预防措施避免类似问题再次发生

### 9.2 高级排查工具

1. **日志分析**：
   - 使用 `grep` 过滤日志
   - 分析错误模式

2. **网络诊断**：
   - 使用 `ping` 和 `traceroute` 测试网络连接
   - 使用 `curl` 测试 API 响应

3. **性能分析**：
   - 使用 `top` 或 `htop` 监控系统资源
   - 使用数据库分析工具检查数据库性能

4. **压力测试**：
   - 使用 `ab` 或 `wrk` 进行简单的压力测试
   - 模拟高并发场景

## 10. 常见错误代码解释

### 10.1 HTTP 错误代码

| 错误代码 | 含义 | 可能原因 |
|---------|------|---------|
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 认证失败 |
| 403 | Forbidden | 权限不足 |
| 404 | Not Found | 资源不存在 |
| 500 | Internal Server Error | 服务器内部错误 |
| 502 | Bad Gateway | 后端服务错误 |
| 503 | Service Unavailable | 服务不可用 |
| 504 | Gateway Timeout | 后端服务超时 |

### 10.2 网关特定错误代码

| 错误代码 | 含义 | 可能原因 |
|---------|------|---------|
| GATEWAY_ERR_001 | 数据库连接失败 | 数据库服务异常或连接字符串错误 |
| GATEWAY_ERR_002 | 后端连接失败 | 后端服务异常或配置错误 |
| GATEWAY_ERR_003 | 路由规则未匹配 | 无匹配的路由规则 |
| GATEWAY_ERR_004 | 资源池无可用后端 | 所有后端都已故障 |
| GATEWAY_ERR_005 | 许可证验证失败 | 许可证过期或无效 |

## 11. 最佳实践与预防措施

### 11.1 日常维护

1. **定期备份**：
   - 定期备份配置和数据库
   - 存储备份到安全位置

2. **监控系统**：
   - 定期查看系统状态和日志
   - 设置关键指标告警

3. **更新系统**：
   - 定期更新到最新版本
   - 关注安全补丁

### 11.2 性能优化

1. **合理配置**：
   - 根据实际需求配置系统资源
   - 优化路由规则和资源池

2. **使用缓存**：
   - 合理配置缓存策略
   - 利用 CDN 加速

3. **负载均衡**：
   - 对于高并发场景，使用负载均衡
   - 考虑多区域部署

### 11.3 安全措施

1. **设置强密码**：
   - 为管理界面设置强密码
   - 定期更换密码

2. **限制访问**：
   - 使用 IP 访问控制
   - 考虑使用 VPN 访问管理界面

3. **监控安全**：
   - 定期查看安全告警
   - 分析异常访问模式

## 12. 总结

本文档提供了 Feiyue Emby Gateway 常见问题的排查步骤和解决方案，涵盖了安装、配置、播放、性能等各个方面。在使用过程中遇到问题时，建议按照以下步骤进行排查：

1. **收集信息**：详细描述问题症状，收集相关日志
2. **定位问题**：根据症状和日志定位问题组件
3. **尝试解决方案**：参考本文档的相应部分尝试解决
4. **验证解决方案**：确认问题是否已解决
5. **记录和预防**：记录问题和解决方案，采取预防措施

通过合理的配置和定期维护，可以大大减少 Feiyue Emby Gateway 的故障发生率，提高系统的稳定性和可靠性。如果遇到本文档未覆盖的问题，建议查看官方文档或寻求社区支持。
