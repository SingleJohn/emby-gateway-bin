# 安全功能

Emby Gateway 提供了强大的安全引擎，用于保护您的媒体服务免受恶意访问和攻击。本文档将详细介绍安全功能的配置和使用方法。

## 安全引擎架构

安全引擎基于规则匹配系统，支持多种匹配条件和动作类型：

- **匹配条件**：IP、用户代理、路径、HTTP 方法
- **动作类型**：允许、拒绝、速率限制
- **内置安全开关**：下载功能、离线/转码功能

## 基础配置

### 启用安全引擎

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全规则」
3. 在「基础安全」卡片中，开启「启用安全引擎」开关
4. 开关状态会显示为「已启用」

### 真实 IP 识别

1. 在「真实 IP 识别」卡片中：
   - **Header**：在输入框中填写包含真实 IP 的 HTTP 头部，如 `X-Forwarded-For` 或 `CF-Connecting-IP`
   - **可信代理白名单**：在文本框中输入可信代理的 CIDR 地址，每行一个
   - **信任所有代理**：仅在安全环境中开启此开关，不推荐在公共网络中使用

2. 功能说明
  - 检查请求来源 ：判断 TCP 连接的远程 IP 是否在信任的代理列表中
  - 提取真实 IP ：
  - 如果来自 信任的代理 ：从 X-Forwarded-For 头部提取第一个有效 IP
  - 如果来自 不信任的来源 ：直接使用 TCP 远程 IP
  - X-Forwarded-For 处理 ：格式通常是 客户端IP, 代理1IP, 代理2IP ，取第一个有效 IP

3. 配置后的作用范围
  - 安全规则匹配 
  - 请求日志记录
  - IP 地理位置信息收集
  - IP 统计和监控

**注意**：开启「信任所有代理」会显示「危险」标签，因为这可能导致安全风险。

## 安全规则配置

### 如何创建安全规则

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全规则」
3. 在「高级访问策略」卡片中，点击「新建规则」按钮
4. 在弹出的规则编辑器中填写规则信息
5. 点击「保存」按钮

### 规则配置选项

#### 基本信息
- **名称**：规则的描述性名称
- **启用状态**：开启或关闭规则

#### 匹配条件
- **IP 地址**：添加 CIDR 格式的 IP 范围
- **用户代理**：添加包含的字符串或正则表达式
- **路径**：添加路径前缀或正则表达式
- **HTTP 方法**：选择要匹配的 HTTP 方法（如 GET、POST 等）

#### 动作类型
- **允许**：允许请求通过，不做任何限制
- **拒绝**：拒绝请求，可设置返回的状态码和提示信息
- **速率限制**：限制请求频率，可设置：
  - **限流键**：基于 IP、IP+路径或 IP+用户代理
  - **每秒请求数**：限制每秒的请求数量
  - **突发请求数**：允许的突发请求数量
  - **状态码**：触发限制时返回的状态码

## 内置安全开关

### 禁用下载接口

1. 在「基础安全」卡片中，开启「禁用下载接口 (Direct File)」开关
2. 开启后，用户将无法直接下载媒体文件，保护您的内容

### 禁用离线/转码接口

1. 在「基础安全」卡片中，开启「禁用同步/离线接口 (/Sync)」开关
2. 开启后，用户将无法使用离线同步和转码功能，防止资源滥用

## 规则模板

Web UI 提供了以下规则模板，可直接使用：

1. **拦截常见爬虫/脚本**：阻止常见的爬虫和脚本工具
2. **高频访问限流 (防 CC)**：防止 CC 攻击
3. **拦截 Swagger/Env 扫描**：阻止敏感信息扫描
4. **禁止外部直接下载视频**：防止直接下载视频文件

## 最佳实践

### 规则优先级

规则按照配置顺序执行，一旦匹配成功就停止后续规则的检查。建议：

1. 将最具体的规则放在前面
2. 将默认允许规则放在最后

### 安全建议

1. **启用 IP 白名单**：只允许特定 IP 访问管理接口
2. **配置速率限制**：对敏感接口设置合理的速率限制
3. **监控异常访问**：结合安全告警功能监控异常访问模式
4. **定期更新规则**：根据实际访问情况调整安全规则

### 性能考虑

- 规则数量过多会影响请求处理性能
- 复杂的正则表达式会增加 CPU 使用率
- 建议：
  - 合理设置规则数量
  - 使用简单的路径前缀匹配替代复杂正则
  - 对高频访问的接口进行优化

## 配置示例

### 基本安全配置

**操作步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全规则」
3. 在「基础安全」卡片中：
   - 开启「启用安全引擎」开关
   - 开启「禁用下载接口 (Direct File)」开关
4. 在「真实 IP 识别」卡片中：
   - 在「Header」输入框中填写 `X-Forwarded-For`
   - 在「可信代理白名单」文本框中输入：
     ```
     127.0.0.1/32
     192.168.1.0/24
     ```
5. 在「高级访问策略」卡片中：
   - 点击「模板」按钮，选择「拦截常见爬虫/脚本」模板
   - 点击「新建规则」按钮，创建 API 速率限制规则：
     - 名称：API 速率限制
     - 匹配条件：路径前缀 `/api/`
     - 动作：速率限制
     - 每秒请求数：10
     - 突发请求数：20
6. 点击页面底部的「保存」按钮

### 高级安全配置

**操作步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全规则」
3. 在「基础安全」卡片中，开启「启用安全引擎」开关
4. 在「高级访问策略」卡片中，创建以下规则：

   **规则 1：管理员 IP 白名单**
   - 名称：管理员 IP 白名单
   - 匹配条件：
     - IP 地址：192.168.1.100/32
     - 路径前缀：/admin/
   - 动作：允许

   **规则 2：阻止管理接口访问**
   - 名称：阻止管理接口访问
   - 匹配条件：路径前缀 /admin/
   - 动作：拒绝，状态码 403

   **规则 3：视频流速率限制**
   - 名称：视频流速率限制
   - 匹配条件：
     - 路径正则：/Videos/.*/stream
     - HTTP 方法：GET
   - 动作：速率限制
     - 每秒请求数：5
     - 突发请求数：10

5. 点击页面底部的「保存」按钮
