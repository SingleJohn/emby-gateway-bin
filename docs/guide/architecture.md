# 项目介绍与架构说明

## 1. 项目概述

Feiyue Emby Gateway 是一个功能强大的 Emby 播放网关，专为解决 Emby 媒体服务器的存储分发、高可用和统一管理问题而设计。它能够智能地将播放请求重定向到不同的后端存储（如 S3、CDN、Google Drive 或本地存储），实现流量的智能分发和故障自动切换。

### 核心价值

- **存储灵活扩展**：支持多种存储后端，包括对象存储、CDN、Google Drive 和本地存储
- **高可用性**：通过主备后端配置，实现故障自动切换，提高服务稳定性
- **智能路由**：基于路径规则的请求分发，优化存储使用成本
- **统一管理**：提供直观的管理界面，集中配置所有后端和路由规则
- **可观测性**：完善的日志和统计功能，便于运维监控和故障排查

## 2. 系统架构

### 整体架构

Feiyue Emby Gateway 采用分层架构设计，核心组件关系如下图：

![Feiyue Emby Gateway 架构图](/diagrams/architecture-overview.svg)


## 3. 工作流程

### 播放请求处理流程

![播放请求时序图](/diagrams/playback-sequence.svg)

> 图源（可编辑）：`docs/assets/diagrams/02-playback-sequence.mmd`

1. **请求接收**：用户通过 Emby 客户端发起播放请求，请求首先到达 Emby Source 入口
2. **路由匹配**：系统根据配置的路由规则，匹配请求路径
3. **路径映射**：如果配置了路径映射，系统会将 Emby 路径转换为后端存储路径
4. **资源池选择**：根据路由规则匹配结果，选择对应的资源池
5. **后端选择**：优先选择资源池中的主后端
6. **请求转发**：将请求转发到选中的后端存储
7. **故障切换**：如果主后端失败，系统会自动尝试备后端
8. **响应返回**：后端存储返回媒体数据，经过网关返回给客户端
9. **日志记录**：系统记录请求处理过程和结果

### 配置管理流程

1. **配置修改**：管理员通过管理后台修改配置
2. **配置存储**：配置被存储到配置数据库
3. **配置加载**：系统实时或定期加载最新配置
4. **配置生效**：新配置立即或在下次请求时生效

## 4. 架构演进

Feiyue Emby Gateway 采用模块化设计，便于后续功能扩展和架构演进：

- **存储后端扩展**：可轻松添加新的存储类型
- **路由规则增强**：支持更复杂的匹配逻辑
- **监控系统集成**：可与 Prometheus、Grafana 等监控系统集成
- **自动化运维**：支持配置的版本管理和回滚

通过不断的架构优化和功能增强，Feiyue Emby Gateway 将为 Emby 媒体服务器提供更加稳定、高效和灵活的存储分发解决方案。
