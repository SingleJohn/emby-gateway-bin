# 路由规则和资源池配置指南

本文档详细介绍 Emby Gateway 的路由规则和资源池配置方法，帮助您实现请求的智能分发和高可用架构。

## 1. 核心概念

### 1.1 路由规则

路由规则决定了哪些请求应该使用哪个资源池。每条路由规则包含以下关键信息：

- **名称**：规则的标识符
- **路径前缀**：匹配请求路径的前缀
- **资源池**：匹配后使用的资源池
- **优先级**：规则的执行顺序
- **是否启用**：规则是否生效

### 1.2 资源池

资源池是后端存储的集合，用于实现主备切换和负载均衡。每个资源池包含以下关键信息：

- **名称**：资源池的标识符
- **后端**：包含一个或多个后端，分为主后端和备后端
- **是否启用**：资源池是否生效

## 2. 资源池配置

### 2.1 功能说明

资源池用于管理后端存储的主备关系，实现故障自动切换，提高系统可用性。

### 2.2 配置步骤

1. 点击左侧菜单中的 **资源池**
2. 点击 **添加** 按钮
3. 填写以下信息：
   - **名称**：给资源池起一个易于识别的名称
   - **描述**：可选，资源池的描述信息
4. 在 **后端** 部分，点击 **添加后端**
5. 选择后端类型：
   - **主后端**：优先使用的后端
   - **备后端**：主后端失败时使用的后端
6. 选择具体的后端
7. 可选：设置后端权重（用于负载均衡）
8. 点击 **保存**

### 2.3 资源池配置示例

#### 单后端资源池（最简单）

```
名称：s3-only
后端：
  - 类型：主后端
    后端：s3-primary
```

#### 主备后端资源池（推荐）

```
名称：s3-with-backup
后端：
  - 类型：主后端
    后端：s3-primary
  - 类型：备后端
    后端：s3-backup
```

#### 多备后端资源池（高可用）

```
名称：multi-backend
后端：
  - 类型：主后端
    后端：cdn-primary
  - 类型：备后端
    后端：s3-backup
  - 类型：备后端
    后端：local-storage
```

### 2.4 资源池工作原理

1. 当请求到达时，系统首先尝试使用资源池中的主后端
2. 如果主后端失败（如连接超时、返回错误等），系统会自动尝试备后端
3. 系统会按照配置的顺序依次尝试所有后端，直到找到可用的后端
4. 如果所有后端都失败，系统会返回错误

### 2.5 资源池最佳实践

- **生产环境**：至少配置一个主后端和一个备后端，提高可用性
- **多区域部署**：使用不同区域的后端作为主备，提高容灾能力
- **混合存储**：结合不同类型的后端，优化成本和性能

## 3. 路由规则配置

### 3.1 功能说明

路由规则用于根据请求路径匹配相应的资源池，实现请求的智能分发。

### 3.2 配置步骤

1. 点击左侧菜单中的 **路由规则**
2. 点击 **添加** 按钮
3. 填写以下信息：
   - **名称**：给规则起一个易于识别的名称
   - **路径前缀**：例如 `/movies` 或 `/tv`
   - **资源池**：选择目标资源池
   - **优先级**：设置规则优先级（数字越小优先级越高）
   - **是否启用**：勾选启用
4. 点击 **保存**

### 3.3 路由规则配置示例

#### 默认规则（兜底）

```
名称：default
路径前缀：/
资源池：default-pool
优先级：100
```

#### 电影路径规则

```
名称：movies
路径前缀：/movies
资源池：movies-pool
优先级：10
```

#### 电视剧路径规则

```
名称：tv
路径前缀：/tv
资源池：tv-pool
优先级：10
```

#### 音乐路径规则

```
名称：music
路径前缀：/music
资源池：music-pool
优先级：10
```

### 3.4 路由规则匹配逻辑

1. 系统按照优先级从高到低（数字从小到大）遍历所有启用的路由规则
2. 对于每个请求，系统会检查请求路径是否以规则的路径前缀开头
3. 一旦找到匹配的规则，系统会使用该规则指定的资源池
4. 如果没有找到匹配的规则，系统会返回错误（建议配置默认规则）

### 3.5 路由规则优先级

- **优先级数字越小**：规则优先级越高，越先执行
- **路径前缀长度**：当优先级相同时，路径前缀更长的规则会先匹配
- **默认规则**：建议配置一个路径前缀为 `/` 的默认规则，优先级设置为较高的数字（如 100）

## 4. 路由和资源池的组合使用

### 4.1 单路由单资源池（最简单）

**适用场景**：所有请求使用相同的后端存储

**配置示例**：
- 创建一个包含主备后端的资源池
- 创建一个路径前缀为 `/` 的默认路由规则

### 4.2 多路由多资源池（按类型分流）

**适用场景**：不同类型的媒体使用不同的存储后端

**配置示例**：
- 创建多个资源池，分别对应电影、电视剧、音乐等
- 创建多条路由规则，根据路径前缀匹配不同的资源池

### 4.3 多路由混合资源池（复杂场景）

**适用场景**：需要根据内容类型和访问模式优化存储策略

**配置示例**：
- 创建包含 CDN 和 S3 的资源池用于热门内容
- 创建包含本地存储的资源池用于局域网访问
- 创建多条路由规则，根据路径和文件类型匹配不同的资源池

## 5. 配置最佳实践

### 5.1 命名规范

- **资源池**：使用描述性名称，如 `movies-primary`、`tv-backup` 等
- **路由规则**：使用路径相关的名称，如 `movies-route`、`tv-route` 等

### 5.2 优先级设置

- **具体规则**：优先级设置为较小的数字（如 1-50）
- **默认规则**：优先级设置为较大的数字（如 100）
- **同类型规则**：优先级设置为相同的值，依靠路径长度匹配

### 5.3 资源池配置

- **生产环境**：每个资源池至少包含一个主后端和一个备后端
- **后端选择**：根据内容类型和访问模式选择合适的后端
- **健康检查**：定期检查后端健康状态，及时发现问题

### 5.4 路由规则配置

- **路径规划**：在 Emby 服务器中规划好媒体文件的路径结构
- **规则覆盖**：确保重要路径有专门的规则覆盖
- **默认规则**：始终配置一个默认规则作为兜底

## 6. 高级配置

### 6.1 路径映射与路由规则的结合

路径映射用于解决 Emby 路径与后端存储路径不一致的问题，可以与路由规则结合使用：

1. 配置路径映射，将 Emby 路径转换为后端存储路径
2. 配置路由规则，根据转换后的路径匹配资源池

### 6.2 负载均衡配置

在资源池中，可以设置后端的权重，实现负载均衡：

1. 在资源池中添加多个主后端
2. 为每个主后端设置权重
3. 系统会根据权重比例分发请求
