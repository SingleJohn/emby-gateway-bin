# 基础配置

以最小配置为例，按顺序配置即可。

## 需要配置的 4 个对象

1. `Source`：入口（你的 Emby 播放请求从哪里进来）
2. `后端`：存储目标（S3/CDN/GDrive/本地等）
3. `资源池`：把后端组成主备关系
4. `路由规则`：决定哪些请求走哪个资源池


## 配置顺序

### 1. 第一步：新增 Source（入口）

> **`docker` 部署的服务，新增 `source` 后，需要注意放开对应的端口**

在管理后台新增一个 Source，最少填这些：

- 名称（随意但建议易懂）
- 监听端口（例如 `18889`）
- 上游 Emby 地址（Host）

建议：先只建一个 Source，确认能正常播放后再扩展。

### 2. 第二步：新增后端（存储）

按你的实际存储类型新增后端，例如：

- S3
- CDN
- GDrive
- 本地（Local / Local Agent）

每个后端都先做一次连通性确认，再进入下一步。

### 3. 第三步：创建资源池（主备关系）

创建 1 个资源池并设置：

- 主后端（Primary）
- 备后端（Standby，可选但强烈建议）

这样主后端异常时能自动切备，体验更稳。

### 4. 第四步：配置路径映射（可选）

如果你的 Emby 路径和后端路径不一致，需要加路径映射。

常见示例：

- Emby 路径前缀：`/mnt/media`
- 后端实际前缀：`/media`

如果路径一致，可以先不配映射。

### 5. 第五步：配置路由规则

创建一条默认路由（兜底）：

- 绑定到上一步资源池
- 优先级设置成较大的数（例如 100）
- 先保证“所有请求都能命中”

后续再逐步加精细规则（按目录分流）。

### 6. 第六步：播放验证

验证顺序：

1. 客户端能正常发起播放
2. 后台看到请求命中对应规则
3. 可以看到重定向到预期后端
4. 播放连续 5-10 分钟无中断



##  配置详细说明


### Source（入口）

- 用来接收 Emby 播放请求
- 关键项：监听端口、上游 Emby 地址
- 建议：先只建 1 个 Source，验证通过后再增加

### 后端（存储）

- 支持：S3、CDN、GDrive、本地等
- 建议：每新增一个后端都先做连通性确认

### 资源池（主备）

- 把后端组合成主备关系
- 建议：生产环境必须配置备后端，降低播放失败风险

### 路由规则（分流）

- 决定哪些请求走哪个资源池
- 建议：保留一条"兜底规则"，避免请求漏匹配

### 路径映射（按需）

- 仅当 Emby 路径与后端路径不一致时才需要配置
- 常见错误：`from/to` 写反，导致请求找不到资源

## 其它配置问题

### 推荐默认策略

| 项目 | 建议 |
|---|---|
| Source 数量 | 初期 1 个即可 |
| 资源池 | 主后端 + 备后端 |
| 路由规则 | 先 1 条兜底规则，后续再细分 |
| 路径映射 | 路径一致就先不配 |
| 观测与日志 | 保持默认，先看稳定性再调优 |

### 什么配置改完会立刻生效

- 路由、后端、资源池这类业务配置：通常保存后立即生效
- 涉及监听行为的变更（例如端口/新增入口）：通常需要重启进程

### 常见配置误区

1. 只配了后端，忘了建资源池
2. 资源池建好了，路由没绑定它
3. 路由优先级冲突，命中顺序不符合预期
4. 路径映射方向写反
5. 忘记保存配置
6. 配置了路由规则，但 Emby 路径与规则不匹配

## 9. 截图补充位（后续可直接替换）

建议把对应页面截图放到 `docs/assets/images/`，并按如下文件名补充：

- `02-source-config.png`
- `03-backend-config.png`
- `04-resource-pool.png`
- `05-route-rule.png`
