# 路由匹配规则详解

本页专门说明 Emby Gateway 在播放拦截场景下的路由匹配与回退行为。

名词说明： 代理播放 指的是 Emby 原始的播放链路，未被 Emby Gateway 拦截。

## 1. 核心结论

1. 路由按 `priority` 升序匹配，数字越小越先匹配。
2. 命中第一条路由后就停止，不会继续看后续路由。
3. 一条路由命中后，只会在该路由绑定的资源池内做主备尝试。
4. 如果该路由后续失败，不会切到下一条路由，而是回退到代理播放。

## 2. 匹配顺序

匹配顺序分两层：

1. 先筛选 `enabled=true` 的路由。
2. 再按 `priority` 从小到大排序并依次匹配。

当多个路由 `priority` 相同，保持配置中的原始顺序（稳定排序）。

## 3. 什么算“命中路由”

一条路由的 `match` 条件满足任意一项即命中：

1. `Prefix` 任一前缀匹配。
2. `Regex` 任一正则匹配。

如果该路由的 `Prefix` 和 `Regex` 都为空，则该路由为“全匹配路由”（可理解为兜底匹配）。

## 4. 命中后的处理

命中某条路由后，会继续执行：

1. 找到该路由绑定的 `映射集`。
2. 执行路径映射（`强制映射` 开启时必须映射成功，映射失败会直接丢弃请求，不会回退到代理播放）。
3. 找到该路由绑定的 `资源池`。
4. 在该资源池中按顺序尝试 `主后端 -> 备后端` 生成直链。
5. 任一后端成功则返回 `302` 重定向。

## 5. 失败回退规则

关键点：只要已经命中一条路由，后续失败不会再尝试下一条路由。

例如：

1. `Route#1` 命中。
2. 但 `Route#1` 的路径映射失败，或资源池内主备后端都失败。
3. 系统不会再试 `Route#2`，而是回退到代理播放链路。

## 6. 时序图（多路由 + 多资源池）

![播放请求时序图（多路由规则 + 多资源池 + 代理回退）](/diagrams/playback-sequence-multi-routes-pools.svg)

图文件：`docs/public/diagrams/playback-sequence-multi-routes-pools.svg`

