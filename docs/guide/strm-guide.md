# STRM 功能指南

本文档详细介绍 Emby Gateway 的 STRM 功能，包括其原理、配置方法和使用指南。

## 1. STRM 功能概述

### 1.1 什么是 STRM 功能

STRM 功能是 Emby Gateway 的一项核心能力，用于将后端存储中的媒体文件映射为本地的 `.strm` 文件。这些 `.strm` 文件包含指向实际媒体文件的链接，使 Emby 能够通过 strm 文件来扫描和播放存储在各种后端的媒体文件，实现刮削文件与视频存储的分离，提高性能。

### 1.2 适用场景

- **多后端管理**：统一管理存储在不同后端（如 S3、本地存储、123盘等）的媒体文件
- **自动化同步**：定期自动同步后端存储的文件变化到本地 `.strm` 文件，支持增量同步
- **智能清理**：自动删除失效的 `.strm` 文件（存储端删除或移动文件以后），保持文件系统整洁

### 1.3 核心优势

- **简化配置**：通过配置文件集中管理所有媒体文件的访问路径
- **提高性能**：减少 Emby 直接访问后端存储的频率
- **增强可靠性**：通过本地 `.strm` 文件作为中间层，提高媒体文件的访问稳定性
- **支持多种后端**：兼容 S3、本地存储、Local Agent 和 123 盘等多种后端类型

## 2. 支持的后端类型

STRM 功能支持以下后端类型：

| 后端类型 | 支持情况 | 特点 |
|---------|---------|------|
| S3 | 完全支持 | 通过 API 扫描文件，支持分页和续传 |
| 本地存储 | 完全支持 | 直接扫描本地文件系统 |
| Local Agent | 完全支持 | 通过 Agent API 扫描远程文件系统 |
| 123 网盘 | 完全支持 | 通过 123 网盘 API 扫描文件 |
| 阿里云 CDN | 不支持 | CDN 为分发网络，不适合作为扫描源 |
| Google Drive | 不支持 | 需要特殊处理，暂未集成 |

## 3. 配置 STRM 功能

### 3.1 访问 STRM 配置页面

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的 **STRM** 选项
3. 进入 STRM 配置页面

### 3.2 创建 STRM Profile  

STRM Profile 是 STRM 功能的核心配置单元，每个 Profile 对应一个后端存储的媒体文件集合。

1. 点击 **新增 Profile** 按钮
2. 填写以下基本信息：
   - **名称**：给 Profile 起一个易于识别的名称
   - **Base URL**：Gateway 的基础 URL，用于生成 `.strm` 文件中的链接
   - **Backend**：选择用于扫描的后端存储
   - **Source Prefix**：源路径前缀，指定扫描的起始路径
   - **Output Dir**：输出目录，指定生成的 `.strm` 文件存储位置
   - **Video Extensions**：视频文件扩展名列表，指定需要处理的视频文件类型

3. 配置同步选项：
   - **定时同步间隔（秒）**：设置自动同步的时间间隔
   - **去掉源扩展名**：是否在生成 `.strm` 文件时去掉源文件的扩展名
      - 开启：movie.mkv → movie.strm
      - 关闭：movie.mkv → movie.mkv.strm  
   - **删除失效文件**：是否自动删除失效的 `.strm` 文件（存储端删除或移动文件以后）



4. 点击 **保存** 按钮保存配置

## 4. 管理 STRM 同步

### 4.1 手动触发同步

1. 在 STRM 配置页面找到需要同步的 Profile
2. 点击 **手动同步** 按钮
3. 系统会开始执行同步任务，并显示任务状态

### 4.2 重置并重扫

当需要重新扫描所有媒体文件时，可以使用重置重扫功能：

1. 在 STRM 配置页面找到需要重置的 Profile
2. 点击 **重置重扫** 按钮
3. 系统会重置该 Profile 的同步状态，并开始全量重扫

### 4.3 查看同步状态

在每个 Profile 的状态显示区，可以查看：
- 当前同步任务的状态（运行中、已入队、空闲）
- 队列长度
- 当前任务的详细信息（Job ID、模式、轮次等）
- 最近任务的执行情况

## 5. 查看同步历史

### 5.1 最近任务列表

在 STRM 配置页面的 **最近任务** 部分，可以查看所有 Profile 的同步任务历史，包括：
- 任务状态（运行中、已完成）
- Profile 名称
- Job ID
- 触发方式
- 模式
- 轮次
- 处理的页数、API 调用次数
- 扫描、匹配、写入、跳过、删除的文件数量
- 错误数量
- 耗时
- 开始和结束时间

### 5.2 任务详情  

1. 在最近任务列表中找到需要查看的任务
2. 点击 **详情** 按钮
3. 进入任务详情页面，查看该任务的详细执行记录，包括：
   - 操作类型（写入、跳过、删除、错误）
   - 对象键
   - 本地路径
   - 错误信息
   - 操作时间

