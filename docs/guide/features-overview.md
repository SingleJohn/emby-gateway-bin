# 功能总览

本文档面向所有用户，旨在介绍 emby-gateway 的功能、适用场景及配置指南。

## 1. 核心能力

| 功能 | 作用 | 常见场景 |
|---|---|---|
| 多后端分流 | 把播放请求分发到不同存储后端 | 同时使用 S3、CDN、本地盘 |
| 路由规则 | 基于路径前缀的智能路由，实现请求的精细化分发 | 电影/剧集走不同存储 |
| 资源池 | 管理后端存储的主备关系，实现故障自动切换 | 降低播放失败率 |
| 路径映射 | 解决 Emby 路径与后端存储路径不一致的问题 | Emby 路径与实际存储路径不同时 |
| 本地文件直链 | 本地目录通过签名直链访问 | 家庭 NAS、本地盘 |
| GDrive 直链 | 支持 Google Drive 回源 | 海外存储场景 |
| 请求日志与统计 | 看访问、状态码、失败趋势 | 日常运维与排障 |
| 安全告警 | 监控异常访问行为，及时发现安全威胁 | 账号共享检测、异常访问频率 |
| 通知系统 | 通过多渠道发送告警通知与测试通知 | 企业微信、钉钉、Telegram、Bark、Server酱 |
| 安全规则 | 基于 IP、路径、用户代理的访问控制 | 阻止爬虫、限制访问频率 |
| 许可证管理 | 激活和管理软件许可证 | 功能授权、状态监控 |

## 2. 你需要配置的 4 个对象

1. `Source`：入口（你的 Emby 播放请求从哪里进来）
2. `后端`：存储目标（S3/CDN/GDrive/本地等）
3. `资源池`：把后端组成主备关系
4. `路由规则`：决定哪些请求走哪个资源池

你只要按这个顺序配置，基本不会乱。

## 3. 典型使用场景

### 场景 A：单后端（最简单）

- 1 个 Source + 1 个后端 + 1 条默认路由
- 适合刚开始使用，先跑通链路

### 场景 B：主备高可用

- 1 个资源池里配置“主后端 + 备后端”
- 主后端异常时自动切到备后端

### 场景 C：按路径分流

- 电影路径走后端 A，剧集路径走后端 B
- 常用于冷热数据分层、成本优化

## 4. 配置详细说明

### 4.1 配置顺序（照着做最稳）

1. 先配 `Source`（入口）
2. 再配 `后端`（存储）
3. 再配 `资源池`（主备）
4. 最后配 `路由规则`（分流）

如果你是第一次使用，建议先做"单路由 + 单后端"跑通，再逐步加复杂规则。

### 4.2 后台关键配置项

#### Source（入口）

- 用来接收 Emby 播放请求
- 关键项：监听端口、上游 Emby 地址
- 建议：先只建 1 个 Source，验证通过后再增加

#### 后端（存储）

- 支持：S3、CDN、GDrive、本地等
- 建议：每新增一个后端都先做连通性确认

#### 资源池（主备）

- 把后端组合成主备关系
- 建议：生产环境必须配置备后端，降低播放失败风险

#### 路由规则（分流）

- 决定哪些请求走哪个资源池
- 建议：保留一条"兜底规则"，避免请求漏匹配

#### 路径映射（按需）

- 仅当 Emby 路径与后端路径不一致时才需要配置
- 常见错误：`from/to` 写反，导致请求找不到资源

### 4.3 推荐默认策略

| 项目 | 建议 |
|---|---|
| Source 数量 | 初期 1 个即可 |
| 资源池 | 主后端 + 备后端 |
| 路由规则 | 先 1 条兜底规则，后续再细分 |
| 路径映射 | 路径一致就先不配 |
| 观测与日志 | 保持默认，先看稳定性再调优 |

### 4.4 什么配置改完会立刻生效

- 路由、后端、资源池这类业务配置：通常保存后立即生效
- 涉及监听行为的变更（例如端口/新增入口）：通常需要重启进程

### 4.5 常见配置误区

1. 只配了后端，忘了建资源池
2. 资源池建好了，路由没绑定它
3. 路由优先级冲突，命中顺序不符合预期
4. 路径映射方向写反

### 4.6 高级部署项（可选）

以下为运维相关配置项，普通用户可根据实际需要选择配置：

- 数据库连接方式（SQLite / PostgreSQL）
- 管理端监听地址与端口
- 授权相关启动参数与环境变量

如果你只是日常使用，按前 5 节即可。

## 5. 配置入口建议

- 新用户先看：`快速开始`
- 实操配置看：`一步步配置指南`
- 路由逻辑看：`路由与故障切换`
- GDrive 专项看：`GDrive Worker 指南`
