# 安全告警

Emby Gateway 提供了强大的安全告警系统，用于监控和检测异常访问模式。本文档将详细介绍安全告警系统的配置和使用方法。

## 告警系统架构

安全告警系统基于定时任务机制，定期检查访问日志并分析异常行为：

- **定时执行**：根据配置的执行周期，定期检查告警规则
- **多维度分析**：支持按用户 ID 或 IP 地址聚合分析
- **多渠道通知**：通过配置的通知渠道发送告警信息
- **告警去重**：避免短时间内重复发送相同告警

## 启用安全告警

**操作步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全告警」
3. 在「全局设置」卡片中：
   - 开启「启用安全告警」开关
   - 在「执行周期 (秒)」输入框中填写执行周期，建议设置为 60-300 秒
4. 点击页面底部的「保存」按钮

**提示**：执行周期设置过短会增加系统负担，设置过长会导致告警延迟。

## 告警类型

### 1. 访问频率告警

监控指定时间窗口内的请求频率，当请求数超过阈值时触发告警。

**配置步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全告警」
3. 在「告警规则」卡片中，点击「添加规则」按钮
4. 填写规则信息：
   - **名称**：高频访问检测
   - **类型**：访问频率/次数
   - **统计维度**：用户 (emby_user_id)
   - **统计窗口 (秒)**：3600
   - **冷却时间 (秒)**：1800
   - **通知渠道**：选择要使用的通知渠道（如企业微信、钉钉）
   - **适用 Source**：选择要监控的 Emby 服务器（留空表示全部）
   - **请求数阈值**：200
5. 点击「保存」按钮

### 2. 身份漂移告警

监控用户身份的异常变化，检测可能的账号共享或盗用情况。

**配置步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全告警」
3. 在「告警规则」卡片中，点击「添加规则」按钮
4. 填写规则信息：
   - **名称**：身份漂移检测
   - **类型**：身份漂移
   - **统计维度**：用户 (emby_user_id)
   - **统计窗口 (秒)**：3600
   - **冷却时间 (秒)**：1800
   - **通知渠道**：选择要使用的通知渠道（如企业微信、Telegram）
   - **适用 Source**：留空表示监控所有服务器
   - **最小请求数**：50
   - **IP 数阈值**：5
   - **UA 数阈值**：5
5. 点击「保存」按钮

### 3. 失败率告警

监控请求失败率，当失败率超过阈值时触发告警，检测可能的攻击或系统异常。

**配置步骤**：

1. 登录 Emby Gateway 管理界面
2. 点击左侧菜单中的「安全告警」
3. 在「告警规则」卡片中，点击「添加规则」按钮
4. 填写规则信息：
   - **名称**：失败率异常检测
   - **类型**：异常失败率
   - **统计维度**：IP (client_ip)
   - **统计窗口 (秒)**：3600
   - **冷却时间 (秒)**：1800
   - **通知渠道**：选择要使用的通知渠道（如企业微信、Server酱）
   - **适用 Source**：留空表示监控所有服务器
   - **最小请求数**：50
   - **失败率阈值**：0.3（30%）
5. 点击「保存」按钮

## 通知配置

安全告警需要配置通知渠道才能发送告警信息：

1. 在通知中心配置至少一个通知渠道
2. 在告警规则中选择要使用的通知渠道
3. 确保通知系统已启用

**说明**：告警规则中选择的是通知渠道 `id`（例如 `wecom_ops`），不是渠道类型名。

## 告警触发流程

1. 定时任务检查告警规则
2. 对每条启用的规则执行统计分析
3. 检查是否满足告警条件
4. 去重处理（避免重复告警）
5. 通过配置的渠道发送告警通知
6. 记录告警状态，进入冷却期

## 告警信息格式

告警通知包含以下信息：

- **告警类型**：访问频率、身份漂移或失败率
- **统计维度**：用户 ID 或 IP 地址
- **统计窗口**：告警统计的时间范围
- **触发条件**：具体的触发原因和阈值
- **相关信息**：请求数、IP 数、UA 数等详细信息

## 最佳实践

### 规则配置建议

1. **合理设置阈值**：根据实际访问情况调整阈值，避免误报
2. **使用最小请求数**：设置适当的 min_total 值，减少误报
3. **配置冷却时间**：设置合理的 cooldown_seconds，避免重复告警
4. **选择合适的统计维度**：根据监控目标选择合适的 group_by 值
5. **多维度监控**：同时配置按用户和按 IP 的告警规则

### 误报防范

1. **排除正常高访问**：对已知的高访问用户或 IP 进行特殊处理
2. **调整时间窗口**：根据业务场景调整 window_seconds
3. **结合多种告警类型**：综合分析多种告警类型，提高准确性
4. **定期检查告警**：定期检查告警记录，优化规则配置

### 告警响应

1. **及时查看**：收到告警后及时查看相关日志
2. **分析原因**：确定告警是否为误报或真实异常
3. **采取措施**：对真实异常采取相应的安全措施
4. **优化规则**：根据告警情况优化规则配置

